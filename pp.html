<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> <html xmlns="http://www.w3.org/1999/xhtml"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/> <title>with_scope with scope &mdash; err.the_blog</title> <meta name="description" content="Err the Blog: Ruby and Rails from the front." /> <link href="http://feeds.feedburner.com/errtheblog" rel="alternate" title="Err the Blog" type="application/atom+xml" /> <link href="/stylesheets/errtheblog.css?1229993518" media="screen" rel="stylesheet" type="text/css" /> <script src="/javascripts/code_highlighter.js?1229993518" type="text/javascript"></script> <script src="/javascripts/lang/ruby.js?1229993518" type="text/javascript"></script> </head> <body> <div id="wrap"> <div id="header"> <div class="feed"> <a href="http://feeds.feedburner.com/errtheblog"> <img src="/images/feed.png" alt="Err the Blog Atom Feed Icon" /> </a> </div> <div class="logo"> <a href="/" class="reverse">Err the Blog</a> </div> <div style="float:right"> <a href="http://feeds.feedburner.com/errtheblog"><img src="http://feeds.feedburner.com/~fc/errtheblog?bg=ED1166&amp;fg=FFFFFF&amp;anim=0" height="26" width="88" style="border:0" alt="" /></a> </div> <div class="sub"> Rubyisms and Railities </div> </div> <ul class="hfeed" id="post-list"> <li class="hentry post-li" id="post_39"> <div class="sidebar"> <div class="title">&ldquo;<a href="/posts/39-withscope-with-scope" class="reverse url entry-title" rel="bookmark">with_scope with scope</a>&rdquo;</div> <div class="secondary byline">&ndash; <span class="author vcard fn">Chris</span> on <abbr class='published' title='2006-11-28T09:13:00+00:00'>November 28, 2006</abbr> </div><br/> </div> <div class="entry-content main"> <p>Psst. Hey, kid. Yeah, you. You know about <span class="code">around_filter</span>? Yeah? You ever use <span class="code">with_scope</span> with it? Yeah? Okay, cool. Let me give you a spoiler:</p> <p><strong>using <span class="code">with_scope</span> in conjunction with a controller <span class="code">around_filter</span> is evil</strong>.</p> <p>Sorry. You&#8217;re about to get some <a href="http://www.loudthinking.com/arc/000601.html">vinegar</a> in your scope. Read on.</p> <div align="center" style="margin-bottom:5px;"><img src="http://errtheblog.com/static/images/vinegar-scope.jpg" alt="vinegar scope" /></div> <h3>The Scoop</h3> <p>There&#8217;s a pretty cool feature in Rails which is real useful but (don&#8217;t say it) often abused: <span class="code">with_scope</span>. It goes a something like this:</p> <pre class='ruby'> <span class="constant">Movie</span><span class="punct">.</span><span class="ident">with_scope</span> <span class="symbol">:find</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="punct">'</span><span class="string">state = ?</span><span class="punct">',</span> <span class="constant">Movie</span><span class="punct">::</span><span class="constant">NOW_PLAYING</span> <span class="punct">]</span> <span class="punct">}</span> <span class="keyword">do</span> <span class="constant">Movie</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="symbol">:all</span><span class="punct">)</span> <span class="keyword">end</span> </pre> <p>Cha. Any <span class="code">find</span> calls within the <span class="code">with_scope</span> block will have their scope limited to movies with a <span class="code">state</span> equal to the value of the <span class="code">Movie::NOW_PLAYING</span> constant. That <span class="code">Movie.find(:all)</span> call is basically equivalent to <span class="code">Movie.find(:all, :conditions =&gt; [ &#8216;state = ?&#8217;, Movie::NOW_PLAYING ])</span>.</p> <p>Now, here&#8217;s an idea. Let&#8217;s say you have a <span class="code">MovieController</span> which is in charge of, erm, movies. How&#8217;d it look?</p> <pre class='ruby'> <span class="keyword">class </span><span class="class">MovieController</span> <span class="punct">&lt;</span> <span class="constant">ApplicationController</span> <span class="keyword">def </span><span class="method">director</span> <span class="attribute">@director</span> <span class="punct">=</span> <span class="constant">Movie</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">params</span><span class="punct">[</span><span class="symbol">:movie_id</span><span class="punct">]).</span><span class="ident">director</span> <span class="keyword">end</span> <span class="keyword">def </span><span class="method">related_movies</span> <span class="attribute">@related_movies</span> <span class="punct">=</span> <span class="constant">Movie</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="ident">params</span><span class="punct">[</span><span class="symbol">:movie_id</span><span class="punct">]).</span><span class="ident">related_movies</span> <span class="keyword">end</span> <span class="keyword">end</span> </pre> <p>Nice and clean. Just standard <span class="code">find</span> and associations. Let&#8217;s spice it up and say we only want <span class="code">visible</span> movies that are <span class="code"><span class="caps">NOW</span>_PLAYING</span>:</p> <pre class='ruby'> <span class="keyword">class </span><span class="class">MovieController</span> <span class="punct">&lt;</span> <span class="constant">ApplicationController</span> <span class="keyword">def </span><span class="method">director</span> <span class="ident">movie</span> <span class="punct">=</span> <span class="constant">Movie</span><span class="punct">.</span><span class="ident">find_by_id</span><span class="punct">(</span><span class="ident">params</span><span class="punct">[</span><span class="symbol">:movie_id</span><span class="punct">],</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="punct">'</span><span class="string">state = ? AND visible = ?</span><span class="punct">',</span> <span class="constant">Movie</span><span class="punct">::</span><span class="constant">NOW_PLAYING</span><span class="punct">,</span> <span class="constant">true</span> <span class="punct">])</span> <span class="attribute">@director</span> <span class="punct">=</span> <span class="ident">movie</span><span class="punct">.</span><span class="ident">director</span> <span class="keyword">end</span> <span class="keyword">def </span><span class="method">related_movies</span> <span class="ident">movie</span> <span class="punct">=</span> <span class="constant">Movie</span><span class="punct">.</span><span class="ident">find_by_id</span><span class="punct">(</span><span class="ident">params</span><span class="punct">[</span><span class="symbol">:movie_id</span><span class="punct">],</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="punct">'</span><span class="string">state = ? AND visible = ?</span><span class="punct">',</span> <span class="constant">Movie</span><span class="punct">::</span><span class="constant">NOW_PLAYING</span><span class="punct">,</span> <span class="constant">true</span> <span class="punct">])</span> <span class="attribute">@related_movies</span> <span class="punct">=</span> <span class="ident">movie</span><span class="punct">.</span><span class="ident">related_movies</span> <span class="keyword">end</span> <span class="keyword">end</span> </pre> <p>Here we&#8217;re conforming to the new spec by checking for some <span class="code">:conditions</span>. Twice. Kinda gross, and not very <span class="caps">DRY</span>. Maybe we could use <span class="code">with_scope</span>? No, not yet&#8212;it&#8217;d definitely be simpler to setup the <span class="code">movie</span> in a <span class="code">before_filter</span>.</p> <pre class='ruby'> <span class="keyword">class </span><span class="class">MovieController</span> <span class="punct">&lt;</span> <span class="constant">ApplicationController</span> <span class="ident">before_filter</span> <span class="symbol">:set_movie</span> <span class="keyword">def </span><span class="method">director</span> <span class="attribute">@director</span> <span class="punct">=</span> <span class="attribute">@movie</span><span class="punct">.</span><span class="ident">director</span> <span class="keyword">end</span> <span class="keyword">def </span><span class="method">related_movies</span> <span class="attribute">@related_movies</span> <span class="punct">=</span> <span class="attribute">@movie</span><span class="punct">.</span><span class="ident">related_movies</span> <span class="keyword">end</span> <span class="ident">private</span> <span class="keyword">def </span><span class="method">set_movie</span> <span class="attribute">@movie</span> <span class="punct">=</span> <span class="constant">Movie</span><span class="punct">.</span><span class="ident">find_by_id</span><span class="punct">(</span><span class="ident">params</span><span class="punct">[</span><span class="symbol">:movie_id</span><span class="punct">],</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="punct">'</span><span class="string">state = ? AND visible = ?</span><span class="punct">',</span> <span class="constant">Movie</span><span class="punct">::</span><span class="constant">NOW_PLAYING</span><span class="punct">,</span> <span class="constant">true</span> <span class="punct">])</span> <span class="keyword">end</span> <span class="keyword">end</span> </pre> <p>Wow, much better. And now we always have the movie available as an instance variable. However, sometimes you just need more than one movie, ya know?</p> <h3>The List</h3> <p>Say I want, nay, <strong>demand</strong> a list of movies sorted by their release dates. First we&#8217;d have to change the <span class="code">before_filter</span> to this:</p> <pre class='ruby'> <span class="ident">before_filter</span> <span class="symbol">:set_movie</span><span class="punct">,</span> <span class="symbol">:except</span> <span class="punct">=&gt;</span> <span class="symbol">:all_movies</span> </pre> <p>Then we&#8217;d add some sort of <span class="code">all_movies</span> method, like yah:</p> <pre class='ruby'> <span class="keyword">def </span><span class="method">all_movies</span> <span class="attribute">@movies</span> <span class="punct">=</span> <span class="constant">Movie</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="symbol">:all</span><span class="punct">,</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="punct">'</span><span class="string">state = ? AND visible = ?</span><span class="punct">',</span> <span class="constant">Movie</span><span class="punct">::</span><span class="constant">NOW_PLAYING</span><span class="punct">,</span> <span class="constant">true</span> <span class="punct">],</span> <span class="symbol">:order</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">release_date DESC</span><span class="punct">')</span> <span class="keyword">end</span> </pre> <p>Those damn <span class="code">:conditions</span> again. Exactly the same as before, only this time without the elegance of a <span class="code">before_filter</span>. Le sigh. Okay, bust out <span class="code">with_scope</span>.</p> <h3>The around_filter</h3> <p>Rails 1.2 has a new feature called <span class="code">around_filter</span>. It allows you to run code both before and after (&#8220;around&#8221;) the actions in a controller. From docs:</p> <pre class='ruby'> <span class="ident">around_filter</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">controller</span><span class="punct">,</span> <span class="ident">action</span><span class="punct">|</span> <span class="ident">logger</span><span class="punct">.</span><span class="ident">debug</span> <span class="punct">&quot;</span><span class="string">before <span class="expr">#{controller.action_name}</span></span><span class="punct">&quot;</span> <span class="ident">action</span><span class="punct">.</span><span class="ident">call</span> <span class="ident">logger</span><span class="punct">.</span><span class="ident">debug</span> <span class="punct">&quot;</span><span class="string">after <span class="expr">#{controller.action_name}</span></span><span class="punct">&quot;</span> <span class="keyword">end</span> </pre> <p>Hey&#8230; what if we just ran our controller actions in a <span class="code">with_scope</span> block, scoped to <span class="code"><span class="caps">NOW</span>_PLAYING</span> and <span class="code">visible</span> movies? Then we could delete all those <span class="code">:conditions</span> parameters and let the <span class="code">around_filter</span> worry about it!</p> <p>Let&#8217;s throw something together:</p> <pre class='ruby'> <span class="keyword">class </span><span class="class">MovieController</span> <span class="punct">&lt;</span> <span class="constant">ApplicationController</span> <span class="ident">before_filter</span> <span class="symbol">:set_movie</span><span class="punct">,</span> <span class="symbol">:except</span> <span class="punct">=&gt;</span> <span class="symbol">:all_movies</span> <span class="ident">around_filter</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">controller</span><span class="punct">,</span> <span class="ident">action</span><span class="punct">|</span> <span class="constant">Movie</span><span class="punct">.</span><span class="ident">with_scope</span> <span class="symbol">:find</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="punct">'</span><span class="string">state = ? AND visible = ?</span><span class="punct">',</span> <span class="constant">Movie</span><span class="punct">::</span><span class="constant">NOW_PLAYING</span><span class="punct">,</span> <span class="constant">true</span> <span class="punct">]</span> <span class="punct">}</span> <span class="keyword">do</span> <span class="ident">action</span><span class="punct">.</span><span class="ident">call</span> <span class="keyword">end</span> <span class="keyword">end</span> <span class="keyword">def </span><span class="method">director</span> <span class="attribute">@director</span> <span class="punct">=</span> <span class="attribute">@movie</span><span class="punct">.</span><span class="ident">director</span> <span class="keyword">end</span> <span class="keyword">def </span><span class="method">related_movies</span> <span class="attribute">@related_movies</span> <span class="punct">=</span> <span class="attribute">@movie</span><span class="punct">.</span><span class="ident">related_movies</span> <span class="keyword">end</span> <span class="keyword">def </span><span class="method">all_movies</span> <span class="attribute">@movies</span> <span class="punct">=</span> <span class="constant">Movie</span><span class="punct">.</span><span class="ident">find</span><span class="punct">(</span><span class="symbol">:all</span><span class="punct">,</span> <span class="symbol">:order</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">release_date DESC</span><span class="punct">')</span> <span class="keyword">end</span> <span class="ident">private</span> <span class="keyword">def </span><span class="method">set_movie</span> <span class="attribute">@movie</span> <span class="punct">=</span> <span class="constant">Movie</span><span class="punct">.</span><span class="ident">find_by_id</span><span class="punct">(</span><span class="ident">params</span><span class="punct">[</span><span class="symbol">:movie_id</span><span class="punct">])</span> <span class="keyword">end</span> <span class="keyword">end</span> </pre> <p>Cool. I was able to cut down all that <span class="code">:conditions</span> repetition by adding in the <span class="code">around_filter</span> call&#8230; but at what cost?</p> <h2>This. Is. Wrong.</h2> <p>No. Not cool.</p> <p>Don&#8217;t put <span class="code">with_scope</span> in an <span class="code">around_filter</span>. In fact, don&#8217;t ever call <span class="code">Model.with_scope</span> outside the context of <span class="code">Model</span>. When I do this, I just make my code harder to comprehend. You may not think so, you may grok fine, but there is definitely a simpler way which both you <em>and</em> your cohorts will grok without having to always keep in mind there&#8217;s an omnipotent <span class="code">around_filter</span> floating in the sky, affecting your every <span class="code">find</span>.</p> <p>(Also, this sort of thinking is a nasty habit in that <span class="code">with_scope</span> is becoming <span class="code">protected</span> in 2.0, <a href="http://groups.google.com/group/rubyonrails-core/browse_frm/thread/a8e60f340a682977/">sayeth <span class="caps">DHH</span></a>. You&#8217;ll only be able to use it in the context of a model.)</p> <p>So, what&#8217;s the simpler way? Is <span class="code">with_scope</span> even useful at all? Yeah.</p> <h3>The Rails Way</h3> <p><a href="http://therailsway.com/">Jamis Buck</a> (the J-bomb, as I call him) recently wrote about slimming code in <a href="http://weblog.jamisbuck.org/2006/10/18/skinny-controller-fat-model">Skinny Controller, Fat Model</a>&#8212;a superb article. Following his lead, here&#8217;s a real clean way to scope your controller without <span class="code">around_filter</span>:</p> <pre class='ruby'> <span class="keyword">class </span><span class="class">MovieController</span> <span class="punct">&lt;</span> <span class="constant">ApplicationController</span> <span class="ident">before_filter</span> <span class="symbol">:set_movie</span><span class="punct">,</span> <span class="symbol">:except</span> <span class="punct">=&gt;</span> <span class="symbol">:all_movies</span> <span class="keyword">def </span><span class="method">director</span> <span class="attribute">@director</span> <span class="punct">=</span> <span class="attribute">@movie</span><span class="punct">.</span><span class="ident">director</span> <span class="keyword">end</span> <span class="keyword">def </span><span class="method">related_movies</span> <span class="attribute">@related_movies</span> <span class="punct">=</span> <span class="attribute">@movie</span><span class="punct">.</span><span class="ident">related_movies</span> <span class="keyword">end</span> <span class="keyword">def </span><span class="method">all_movies</span> <span class="attribute">@movies</span> <span class="punct">=</span> <span class="constant">Movie</span><span class="punct">.</span><span class="ident">find_playing</span><span class="punct">(</span><span class="symbol">:all</span><span class="punct">,</span> <span class="symbol">:order</span> <span class="punct">=&gt;</span> <span class="punct">'</span><span class="string">release_date DESC</span><span class="punct">')</span> <span class="keyword">end</span> <span class="ident">private</span> <span class="keyword">def </span><span class="method">set_movie</span> <span class="attribute">@movie</span> <span class="punct">=</span> <span class="constant">Movie</span><span class="punct">.</span><span class="ident">find_playing</span><span class="punct">(</span><span class="symbol">:first</span><span class="punct">,</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="punct">'</span><span class="string">id = ?</span><span class="punct">',</span> <span class="ident">params</span><span class="punct">[</span><span class="symbol">:movie_id</span><span class="punct">]</span> <span class="punct">])</span> <span class="keyword">end</span> <span class="keyword">end</span> </pre> <p>See it? I added a <span class="code">find_playing</span> method to the <span class="code">Movie</span> class. And what&#8217;s that gem of a method look like?</p> <pre class='ruby'> <span class="keyword">class </span><span class="class">Movie</span> <span class="punct">&lt;</span> <span class="constant">ActiveRecord</span><span class="punct">::</span><span class="constant">Base</span> <span class="keyword">def </span><span class="method">self.find_playing</span><span class="punct">(*</span><span class="ident">args</span><span class="punct">)</span> <span class="ident">with_scope</span> <span class="symbol">:find</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">[</span> <span class="punct">'</span><span class="string">state = ? AND visible = ?</span><span class="punct">',</span> <span class="constant">NOW_PLAYING</span><span class="punct">,</span> <span class="constant">true</span> <span class="punct">]</span> <span class="punct">}</span> <span class="keyword">do</span> <span class="ident">find</span><span class="punct">(*</span><span class="ident">args</span><span class="punct">)</span> <span class="keyword">end</span> <span class="keyword">end</span> </pre> <p>Now <span class="code">find_playing</span> is delivering to me <span class="code"><span class="caps">NOW</span>_PLAYING</span>, <span class="code">visible</span> movies without fail through <span class="code">with_scope</span>&#8217;s magic.</p> <p>Refreshing. Less, simpler code without any side effects. You see <span class="code">find_playing</span> and don&#8217;t know what it does, you look it up; you&#8217;re not working under the false assumption that <span class="code">find</span> is totally normal while some tricksy <span class="code">with_scope</span> is mucking around in your <span class="code">around_filters</span>. And now I can write a unit test for <span class="code">find_playing</span> directly, to make sure I really know what&#8217;s going on (and that I&#8217;m not programming by accident). Not bad.</p> <h3>Scope!</h3> <p>It&#8217;s okay to realize &#8220;wow, my code sucks&#8221; then frantically refactor it to be cleaner and simpler. I do it daily. In fact, if you&#8217;ve got any other tips about how to skinny up controllers while fattening up models, leave &#8216;em in the comments.</p> <p>Thirsty for more? Here&#8217;s some bedtime reading: another of Jamis&#8217; articles, on <a href="http://weblog.jamisbuck.org/2006/10/7/helping-activerecord-finders-help-you">custom finders</a>.</p> <p>And, finally, a challenge: how would you implement <span class="code">find_playing_by_id</span>? I want to <span class="code">Movie.find_playing_by_id(id)</span>, pass in options, etc etc. Just like a real <span class="code">find_by_id</span>, but scoped like <span class="code">find_playing</span>. Lemme know! Ta.</p> <h3>find_playing_by_id</h3> <p><strong>Update!</strong> <a href="http://blog.emarm.com/">Dan Milliron</a> offers one suggestion: <span class="code">with_playing</span>.</p> <pre class='ruby'> <span class="keyword">class </span><span class="class">Movie</span> <span class="punct">&lt;</span> <span class="constant">ActiveRecord</span><span class="punct">::</span><span class="constant">Base</span> <span class="keyword">def </span><span class="method">self.with_playing</span> <span class="ident">with_scope</span> <span class="symbol">:find</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">[</span> â€˜<span class="ident">state</span> <span class="punct">=</span> <span class="punct">?</span> <span class="constant">AND</span> <span class="ident">visible</span> <span class="punct">=</span> <span class="char">?â€™</span><span class="punct">,</span> <span class="constant">NOW_PLAYING</span><span class="punct">,</span> <span class="constant">true</span> <span class="punct">]</span> <span class="punct">}</span> <span class="keyword">do</span> <span class="keyword">yield</span> <span class="keyword">end</span> <span class="keyword">end</span> <span class="keyword">end</span> </pre> <p>Then you can, in your controller:</p> <pre class='ruby'> <span class="keyword">class </span><span class="class">MovieController</span> <span class="punct">&lt;</span> <span class="constant">ApplicationController</span> <span class="keyword">def </span><span class="method">director</span> <span class="constant">Movie</span><span class="punct">.</span><span class="ident">with_playing</span> <span class="keyword">do</span> <span class="attribute">@director</span> <span class="punct">=</span> <span class="constant">Movie</span><span class="punct">.</span><span class="ident">find_by_id</span><span class="punct">(</span><span class="ident">params</span><span class="punct">[</span><span class="symbol">:movie_id</span><span class="punct">]).</span><span class="ident">director</span> <span class="keyword">end</span> <span class="keyword">end</span> <span class="keyword">end</span> </pre> <p>Not bad, but I do like having <span class="code">find_playing</span> handle the <span class="code">yielding</span> for me to keep my controllers slim. What about this:</p> <pre class='ruby'> <span class="keyword">class </span><span class="class">Movie</span> <span class="punct">&lt;</span> <span class="constant">ActiveRecord</span><span class="punct">::</span><span class="constant">Base</span> <span class="keyword">def </span><span class="method">self.find_playing</span><span class="punct">(*</span><span class="ident">args</span><span class="punct">)</span> <span class="ident">with_playing</span> <span class="keyword">do</span> <span class="ident">find</span><span class="punct">(*</span><span class="ident">args</span><span class="punct">)</span> <span class="keyword">end</span> <span class="keyword">end</span> <span class="keyword">def </span><span class="method">self.find_playing_by_id</span> <span class="ident">with_playing</span> <span class="keyword">do</span> <span class="ident">find_by_id</span><span class="punct">(*</span><span class="ident">args</span><span class="punct">)</span> <span class="keyword">end</span> <span class="keyword">end</span> <span class="keyword">def </span><span class="method">self.with_playing</span> <span class="ident">with_scope</span> <span class="symbol">:find</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="symbol">:conditions</span> <span class="punct">=&gt;</span> <span class="punct">[</span> â€˜<span class="ident">state</span> <span class="punct">=</span> <span class="punct">?</span> <span class="constant">AND</span> <span class="ident">visible</span> <span class="punct">=</span> <span class="char">?â€™</span><span class="punct">,</span> <span class="constant">NOW_PLAYING</span><span class="punct">,</span> <span class="constant">true</span> <span class="punct">]</span> <span class="punct">}</span> <span class="keyword">do</span> <span class="keyword">yield</span> <span class="keyword">end</span> <span class="keyword">end</span> <span class="keyword">end</span> </pre> <p>That works, but if I do Dan&#8217;s <span class="code">with_playing</span> in the controller I get access to all the <span class="code">find_by_*</span> methods&#8212;not just ones I hardcode. That&#8217;s cool, and I want that in my model. So let&#8217;s add some <span class="code">method_missing</span> into my <span class="code">find_playing</span> lifestyle:</p> <pre class='ruby'> <span class="keyword">def </span><span class="method">self.method_missing</span><span class="punct">(</span><span class="ident">method</span><span class="punct">,</span> <span class="punct">*</span><span class="ident">args</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span> <span class="keyword">if</span> <span class="ident">method</span><span class="punct">.</span><span class="ident">to_s</span> <span class="punct">=~</span> <span class="punct">/</span><span class="regex">^find_(all_)?playing_by</span><span class="punct">/</span> <span class="ident">with_playing</span> <span class="keyword">do</span> <span class="keyword">super</span><span class="punct">(</span><span class="ident">method</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">.</span><span class="ident">sub</span><span class="punct">('</span><span class="string">playing_</span><span class="punct">',</span> <span class="punct">'</span><span class="string"></span><span class="punct">'),</span> <span class="punct">*</span><span class="ident">args</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span> <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">super</span><span class="punct">(</span><span class="ident">method</span><span class="punct">,</span> <span class="punct">*</span><span class="ident">args</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span> <span class="keyword">end</span> <span class="keyword">end</span> </pre> <p>This will give us <span class="code">find_playing_by_blah</span> and <span class="code">find_all_playing_by_jlah</span>. Tricky.</p> </div> </li> <div class="commentsblock" id="comments"> <li class="post-li" id="comment_391"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span><a href="http://blog.evanweaver.com" class="reverse vcard url fn" rel="nofollow">evan</a></span>, about 18 hours later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>Ooh ooh! Alias method_missing! Hey! Pick me! Hey, hey!!</p> </div> </div> </li><li class="post-li" id="comment_392"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span>Vlad</span>, about 18 hours later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>Great article! You&#8217;ve just saved my soul! :)</p> </div> </div> </li><li class="post-li" id="comment_393"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span>Manu</span>, about 20 hours later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>What if all the find calls has a condition user_id = session[:user].id ? That is every model except user has belongs_to :user.</p> </div> </div> </li><li class="post-li" id="comment_394"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span>Arthur</span>, about 22 hours later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>use a @current_user instance var, which gets defined in your ApplicationController. Then you can use e.g:</p> <p>@current_user.movies @current_user.friends</p> </div> </div> </li><li class="post-li" id="comment_395"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span><a href="http://blog.emarm.com" class="reverse vcard url fn" rel="nofollow">Dan Milliron</a></span>, about 23 hours later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>I prefer to put all uses of &#8220;with_scope&#8221; into models and never into controllers. For the use-case in the article, I would define:</p> <p>class Movie &lt; ActiveRecord::Base def self.with_playing with_scope :find =&gt; { :conditions =&gt; [ &#8216;state = ? <span class="caps">AND</span> visible = ?&#8217;, <span class="caps">NOW</span>_PLAYING, true ] } do yield end end end</p> <p>Then I would use it in a controller like this:</p> <p>class MovieController &lt; ApplicationController def director Movie.with_playing do @director = Movie.find(params[:movie_id]).director end end end</p> </div> </div> </li><li class="post-li" id="comment_396"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span>eh</span>, 1 day later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>Hey, put the call to with_playing in your around_filter!!</p> </div> </div> </li><li class="post-li" id="comment_397"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span><a href="http://errtheblog.com" class="reverse vcard url fn" rel="nofollow">Chris</a></span>, 1 day later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>Nooooooooooooooooooooooo!</p> </div> </div> </li><li class="post-li" id="comment_398"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span>bitbutter</span>, 1 day later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>Thanks for the clear writeup. with_scope is making sense to me now.</p> </div> </div> </li><li class="post-li" id="comment_399"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span><a href="http://rubylicio.us/" class="reverse vcard url fn" rel="nofollow">ruby licious</a></span>, 1 day later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>excellent post.</p> </div> </div> </li><li class="post-li" id="comment_400"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span><a href="http://www.mrchucho.net" class="reverse vcard url fn" rel="nofollow">MrChucho</a></span>, 2 days later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>I&#8217;m curious about Manu&#8217;s question, too. If all my models &#8220;belongs_to :user&#8221;, how can I use &#8220;with_scope&#8221; and &#8220;current_user&#8221; to insure that I only get get models where &#8220;[user_id = ?, current_user.id]&#8221;?</p> <p>I just don&#8217;t see a way to do that without passing &#8220;current_user&#8221; to all the find methods. Perhaps that&#8217;s more appropriate anyway&#8230;</p> </div> </div> </li><li class="post-li" id="comment_401"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span><a href="http://errtheblog.com" class="reverse vcard url fn" rel="nofollow">Chris</a></span>, 2 days later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p><span class="code">MrChurcho</span>: You <em>could</em> do something like what <a href="http://www.koziarski.net/archives/2005/7/16/your-application-s-environment">this post by koz describes</a>. I&#8217;m not sure how I feel about it though. Give me time to think.</p> </div> </div> </li><li class="post-li" id="comment_402"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span><a href="http://www.pluitsolutions.com" class="reverse vcard url fn" rel="nofollow">Herry</a></span>, 2 days later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>Oh&#8230;this is sweeeett. Thanks!</p> </div> </div> </li><li class="post-li" id="comment_403"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span>Jason</span>, 3 days later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>In the interest of keep my C and V slim and putting the fat in my M, I&#8217;m trying to come up with a solution for using custom-build finds within an association. Using your example, say you wanted to look at a list of directors and then each of the movies they&#8217;ve done &#8211; pretty simple, you can Director.find(:all, :include =&gt; :movies). So how about if you want to put date restrictions on this list. Say you already have a method like:</p> <p>def Movie.find_between_dates(start, end) find :all, :conditions =&gt; [&#8216;release_date <span class="caps">BETWEEN</span> ? <span class="caps">AND</span> ?&#8217;, start, end] end</p> <p>Now if I have one director, I can go: some_director.find_between_dates(5.months.ago, 3.months.ago) What can I do with the list of all directors? The easy thing would be a controller that does: @directors = Director.find :all and a view that iterates through @directors and uses director.find_between_dates() (which would be a whole bunch of DB queries &#8211; even if you use :include =&gt; :movies in the original find). Or alternatively, you could do: @directors = Director.find :all, :include =&gt; :movies, :conditions =&gt; [&#8216;movies.release_date <span class="caps">BETWEEN</span> ? <span class="caps">AND</span> ?&#8217;, start, end] # start and end would probably be params or something but then I&#8217;ve just wasted the custom find I built into my Movie model. This example it doesn&#8217;t make much difference, but I have a more complicated real-life situation and I&#8217;d really like to keep this finder in my model. The best I can come up with would be to duplicate the Movie.find_between_dates functionality inside Director, as an object method (e.g., movies_between_dates) that either performs the find (defeating eager loading) or uses a non-AR ruby select.</p> </div> </div> </li><li class="post-li" id="comment_404"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span><a href="http://cho.hapgoods.com/wordpress" class="reverse vcard url fn" rel="nofollow">Chris Hapgood</a></span>, 16 days later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>My first reaction to reading this post was quite positive: â€œHere are some techniques to help move more logic to the modelâ€ which is high on my list of objectives. But I was dismayed to see the trendy fervor building up to hobble with_scope (mostly on other sites). Permit me to outline some excellent uses for with_scope in a controllerâ€¦.</p> <p>First and most topically is the issue of nested RESTful resources. Imagine a MessagesController that deals with Messages. Messages can be viewed as a resource in their own right and RESTfully represented as http://somesite/messages. But they can also be considered child resources of two other resources, dogs and cats, and consequently messages can also be represented as http://somesite/dog/1/messages or http://somesite/cat/26/messages. In each action of my MessagesController, I need to check for the parameter â€˜dog_idâ€™ or â€˜cat_idâ€™ (or none) and ensure that proper restrictions are in place for every model query. I could perform this test in every action and call a custom model method that implements the appropriate scope. Or I could send a programatically constructed method name. But duplicating the test/construction in every action is not very <span class="caps">DRY</span> (my controller gets complicated with cats and dogs before I even start thinking about Messages) and my Message model now has some complex method_missing code, or unDRY method definitions. And please donâ€™t suggest I pass a parameter to a custom finder -the M-C coupling will hurt badly when my second scenario is considered. I would argue that the decoupled nature of with_scope in an around filter suits the explicit scoping implied by nested resources very nicely. It would be slick as snot if a <span class="caps">REST</span> resource definition could also support automatically defining a model scope for that resource. Something like</p> <pre><pre class='ruby'><span class="ident">map</span><span class="punct">.</span><span class="ident">resources</span> <span class="symbol">:cat</span> <span class="punct">{|</span><span class="ident">r</span><span class="punct">|</span> <span class="ident">r</span><span class="punct">.</span><span class="ident">messages</span><span class="punct">,</span> <span class="symbol">:scope_model</span> <span class="punct">=&gt;</span> <span class="symbol">:message</span> <span class="punct">}</span></pre></pre> <p>would automatically Message.with_scope(cat=cat_id) within the resource controller. OK, so this might be going a bit too farâ€¦</p> <p>Secondly, with_scope has the nifty ability to merge independently defined scopes. This allows for a very clean decoupling of orthogonal concepts that would otherwise result in a multitude of custom finders with garishly coupled names. If I need need restrictions for authorization (get authorized data), and I need restrictions for currency (get current data) and I need restrictions for RESTful nesting (get data belonging to parent resource), and I need restrictions for active data (get data that has not been logically deleted) there might be hundreds of different custom model finders needed. Obviously method_missing could <span class="caps">DRY</span> that up quickly, but the method constructor would be horrendously complicated that could build Message.find_active_owner-authorized_current_dog and Message.find_deleted_view-authorized_old_cat. A better solution would be to decouple the overarching restrictions of authorization and explicit parent resources into around_filters leaving a custom finder to deal with currency, logical deletion and, of course, run-time user-defined filter conditions. Now my method_missing only has to build Message.find_active_current and Message.find_deleted_old.</p> <p>To summarize, with_scope in a controller has two excellent applications: 1. The controllerâ€™s entry points are explicitly or consistently scoped, such as with nested RESTful resource controllers, and in many cases, authorization. 2. Numerous orthogonal restrictions that need to be combined, such as (logical deletion) <span class="caps">AND</span> (authorizations) <span class="caps">AND</span> (belongs_to_parent). In these cases, I believe controller-defined with_scope is The Right Stuff.</p> </div> </div> </li><li class="post-li" id="comment_405"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span>Jeff de Vries</span>, 2 months later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>Chris, I think your analysis is right on. I was running into exactly those problems with cross-cutting concerns. And I really like your suggestion for enhancing the resource routing to automatically add the scoping!</p> <p>I hope someone is listening!</p> </div> </div> </li><li class="post-li" id="comment_406"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span><a href="http://www.dcmanges.com" class="reverse vcard url fn" rel="nofollow">Dan Manges</a></span>, 2 months later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>For a plugin to easily use this in your models check out <a href="http://code.google.com/p/scope-out-rails/">scope out</a> &#8211; I <a href="http://dcmanges.com/blog/21">blogged</a> about the advantages</p> </div> </div> </li><li class="post-li" id="comment_407"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span><a href="http://tlau.org" class="reverse vcard url fn" rel="nofollow">Tessa Lau</a></span>, 2 months later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>I&#8217;m trying to use with_scope to implement private records (e.g., del.icio.us bookmarks where some bookmarks can only be seen by the logged-in-user who created them). It seems like the benefit of using with_scope with around_filter or some other controller magic is so that you don&#8217;t have to remember to use with_playing all the time; you can use the normal find() methods and you will be guaranteed that you will only find the public records that this user is allowed to see.</p> <p>The case I&#8217;m worried about is when the other developers on my project start adding new views, and they fail to obey the &#8220;always use with_playing&#8221; rule to find records. This solution seems to require a fair amount of code hygiene to ensure that people never see records they aren&#8217;t permitted to see.</p> </div> </div> </li><li class="post-li" id="comment_1269"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span><a href="www.08000linux.com" class="reverse vcard url fn" rel="nofollow">Coren</a></span>, about 1 year later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>&#8220;using with_scope in conjunction with a controller around_filter is evil.&#8221; =&gt; I do not totally agree with you. You are right that the code is harder to comprehend. But it&#8217;s the only way that I have seen to force scope on relation ships.</p> <p>For instance, if you want to strictly forbid access some objects to some profile, there is (sadly) no other way, <span class="caps">ATM</span>. For instance, the around_filter with_scope trick allows to reduce what is returned by a : @person.dogs . Only dogs that the connected user can see are returned, not all dogs attached to @person.</p> <p>Confidentiality can be necessary on some case, and that&#8217;s the only way I &#8216;ve found to ensure a total encapsulation between different profile and different user.</p> </div> </div> </li><li class="post-li" id="comment_1659"> <div class="sidebar"> <div class="secondary"> <span class="highlight"> <span><a href="http://www.freezzo.com" class="reverse vcard url fn" rel="nofollow">Randy</a></span>, about 1 year later: </span> </div> </div> <div class="main"> <div class="post-comment"> <p>This is an excellent post!</p> <p>I made a post on my <a href="http://www.freezzo.com">blog</a> describing a way to override the default find method for a model, in case you always want your find method using a scope.</p> </div> </div> </li> <li class="post-li"> <div class="sidebar"> <div class="secondary"> Nineteen people have commented. <br/> <span class="highlight"> Chime in. </span> </div> </div> <div class="main"> Sorry, no more comments :( </div> </li> </div> </ul> <div id="footer"> <div class="meta"> This is <a href="/">Err</a>, the weblog of <span class="vcard"><a href="http://www.pjhyett.com" class="url fn">PJ Hyett</a></span> and <span class="vcard"><a href="http://ozmm.org" class="url fn">Chris Wanstrath</a></span>. <br/>All original content copyright &copy;2006-2008 the aforementioned. </div> </div> </div> </body> </html>
